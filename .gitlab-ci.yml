image: go1com/ci-nodejs:node8

cache:
  paths:
    - node_modules/

stages:
  - build
  - test
  - release

build:
  stage: build
  tags: ["aws"]
  cache:
    paths: [node_modules]
    key: "$CI_PROJECT_ID"
  script:
    - yarn install
    - yarn tsc
    - yarn generate-proptypes
    - yarn x0 build docs
  artifacts:
    paths:
      - node_modules
      - build
      - dist
    expire_in: 6h
  only: ["branches"]

test:linting:
  stage: test
  tags: ["aws"]
  script: yarn tslint


release:pages:
  stage: release
  tags: ["aws"]
  script:
    - mkdir public
    - cp -r dist/* public/
  artifacts:
    paths:
      - public # mandatory, other folder won't work
  except:
    - $CI_COMMIT_MESSAGE =~ /\[npm release\]/
  # only:
  #   - master # or dev, the branch you want to publish
    - node_modules/
test:unit:
  stage: test
  tags: ["aws"]
  script:
    - yarn install
    - yarn test --coverage --runInBand
  artifacts:
    paths:
      - coverage
    expire_in: 1h
  except:
    - "tags"


release:npm:
  stage: release
  tags: ["aws"]
  script:
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"
    - npm version patch -m "[npm release] $CI_COMMIT_MESSAGE"
    - git show-ref
    - git push origin
  except:
    - $CI_COMMIT_MESSAGE =~ /\[npm release\]/
# only:
  #   - master # or dev, the branch you want to publish
