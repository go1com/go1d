image: go1com/ci-nodejs:node10

stages:
  - build
  - test
  - release
  - npm-release

build:
  stage: build
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
  script:
    - yarn config set no-progress
    - yarn install --silent
    - yarn "npm:build"
  artifacts:
    paths:
      - node_modules
      - build
      - dist
    expire_in: 6h
  except:
    - "tags"
  only:
    - "original-go1d"

build-dev:
  stage: build
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
  script:
    - yarn config set no-progress
    - yarn install --frozen-lockfile
    - yarn "npm:build"
  artifacts:
    paths:
      - node_modules
      - build
      - dist
    expire_in: 6h
  only: ["branches"]
  except:
    - master
    - "original-go1d"

test:linting:
  stage: test
  script: yarn run tslint
  except:
    - master
    - tags
    - "original-go1d"

test:unit:
  stage: test
  needs: []
  script:
    - yarn config set no-progress
    - yarn install --frozen-lockfile --silent
    - yarn test --no-cache --coverage
  artifacts:
    paths:
      - coverage
    expire_in: 1h
  except:
    - "tags"

release:npm:
  stage: npm-release
  dependencies:
    - build
  before_script:
    - "which ssh-agent || ( apk add -uUv openssh-client)"
    - eval $(ssh-agent -s)
    - echo "$GO1D_PRIVATE_SSH_KEY" |  base64 --decode | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan code.go1.com.au >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - git clone git@code.go1.com.au:${CI_PROJECT_PATH}.git
    - cp -r build ${CI_PROJECT_NAME}/
    - cd ${CI_PROJECT_NAME}
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"
    - git checkout $CI_COMMIT_REF_NAME
    - git branch --set-upstream-to origin/$CI_COMMIT_REF_NAME
    - PACKAGE_VERSION=$(npm version patch -m "[NPM-CI] Publishing Version %s to NPM [skip ci]")
    - git push origin
    - git push origin $PACKAGE_VERSION
    - npm config set scope go1d --global
    - echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}'>.npmrc
    - rm readme.md
    - mv npm-readme.md readme.md
    - npm publish --access public --tag original-go1d # do NOT use tag --latest on original-go1d
  except:
    - "tags"
  only:
    - "original-go1d"
